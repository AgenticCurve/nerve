#------------------------------------------------------------------------------
# direnv configuration – tailored for the Nerve agentic orchestration project
#------------------------------------------------------------------------------
# When you `cd` into the repository direnv will
#   1) create a local `.venv` (Python 3.12) via uv if it doesn't exist yet
#   2) install the project in editable mode with all dependencies
#   3) activate the virtual environment so the CLI tools are on PATH
#
# Leaving the directory unloads the environment automatically.
# Ensure direnv is installed and run `direnv allow` after saving this file.
#------------------------------------------------------------------------------

PY_VER="3.12"
VENV=".venv"

# Optional local overrides may be provided in .envrc.local (not tracked by git)
if [ -f "$PWD/.envrc.local" ]; then
  echo "[direnv] Loading local overrides from .envrc.local"
  . "$PWD/.envrc.local" 2>/dev/null || true
fi

# Create venv on first entry --------------------------------------------------
if [ ! -d "$VENV" ]; then
  if command -v uv >/dev/null 2>&1; then
    echo "[direnv] Creating uv virtualenv ($PY_VER) in $VENV…"
    uv venv "$VENV" -p "$PY_VER"
  else
    echo "[direnv] uv not found; skipping venv creation."
  fi
fi

# Activate the venv for the current direnv session ---------------------------
if [ -f "$VENV/bin/activate" ]; then
  source "$VENV/bin/activate"
  echo "[direnv] Using virtualenv: $(pwd)/$VENV"
fi

# Ensure workspace dependencies are installed
if command -v uv >/dev/null 2>&1; then
  echo "[direnv] Running: uv sync --all-extras"
  uv sync --all-extras --quiet || true
fi

# Optional: export placeholders for secrets that you should set in .envrc.local
export ANTHROPIC_API_KEY="${ANTHROPIC_API_KEY:-}"
export OPENAI_API_KEY="${OPENAI_API_KEY:-}"

echo "[direnv] Ready. If you changed credentials, re-run direnv reload if needed."

# Add local bin directory to PATH for custom scripts -------------------------
PATH_add bin
